<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì„¤ë¬¸ ì‘ë‹µí˜„í™© - êµ°ì‚° ê°•ì†ŒíŠ¹êµ¬</title>
  
  <!-- PWA ì„¤ì • -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4f46e5">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="êµ°ì‚°G2G">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    :root {
      --primary: #4f46e5;
      --primary-dark: #3730a3;
      --primary-light: #eef2ff;
      --accent: #f97316;
      --success: #10b981;
      --warning: #f59e0b;
      --text: #1e293b;
      --text-light: #475569;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --bg: #f8fafc;
      --card: #ffffff;
      --shadow: 0 1px 3px rgba(0,0,0,0.04), 0 8px 24px rgba(0,0,0,0.06);
      --radius: 16px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: linear-gradient(160deg, #eef2ff 0%, #e0e7ff 40%, #c7d2fe 100%);
      min-height: 100vh;
      padding: 24px 16px;
      line-height: 1.6;
    }
    .container { max-width: 1200px; margin: 0 auto; }

    /* í—¤ë” */
    .header {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      color: #fff;
      padding: 28px 32px;
      border-radius: var(--radius);
      margin-bottom: 24px;
      box-shadow: 0 4px 20px rgba(79,70,229,0.25);
    }
    .header h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 4px; }
    .header p { opacity: 0.9; font-size: 0.9rem; }
    .header-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
    .btn-back {
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 8px 20px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }
    .btn-back:hover { background: rgba(255,255,255,0.3); }

    /* í†µê³„ ì¹´ë“œ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: var(--card);
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(226,232,240,0.8);
      text-align: center;
    }
    .stat-icon { font-size: 2rem; margin-bottom: 8px; }
    .stat-value { font-size: 2.2rem; font-weight: 700; color: var(--primary); }
    .stat-label { font-size: 0.85rem; color: var(--text-light); margin-top: 4px; }
    .stat-card.total .stat-value { color: var(--primary); }
    .stat-card.g2g .stat-value { color: var(--accent); }
    .stat-card.general .stat-value { color: var(--success); }
    .stat-card.today .stat-value { color: var(--warning); }
    .stat-card.noresponse .stat-value { color: #dc2626; }

    /* ë©”ì¸ ì¹´ë“œ */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(226,232,240,0.8);
      overflow: hidden;
    }
    .card-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    .card-header h2 { font-size: 1.1rem; font-weight: 700; color: var(--text); }
    .card-body { padding: 24px; }

    /* ê²€ìƒ‰/í•„í„° */
    .filter-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .search-input {
      padding: 10px 14px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 0.9rem;
      width: 240px;
      outline: none;
      transition: border-color 0.2s;
    }
    .search-input:focus { border-color: var(--primary); }
    .filter-select {
      padding: 10px 14px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 0.9rem;
      background: #fff;
      cursor: pointer;
      outline: none;
    }
    .filter-select:focus { border-color: var(--primary); }
    .btn-refresh {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    .btn-refresh:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(79,70,229,0.25); }
    .btn-export {
      background: var(--success);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-export:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16,185,129,0.25); }

    /* í…Œì´ë¸” */
    .table-wrap { overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    thead th {
      background: var(--bg);
      padding: 14px 12px;
      text-align: left;
      font-weight: 600;
      color: var(--text-light);
      border-bottom: 2px solid var(--border);
      white-space: nowrap;
    }
    tbody td {
      padding: 14px 12px;
      border-bottom: 1px solid var(--border);
      color: var(--text);
    }
    tbody tr:hover { background: var(--primary-light); }
    tbody tr:last-child td { border-bottom: none; }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .badge-g2g { background: #fef3c7; color: #92400e; }
    .badge-general { background: #d1fae5; color: #065f46; }
    .text-muted { color: var(--text-muted); }
    .text-center { text-align: center; }

    /* ë¡œë”© */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-light);
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ë¹ˆ ìƒíƒœ */
    .empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    .empty-icon { font-size: 3rem; margin-bottom: 12px; opacity: 0.5; }

    /* í˜ì´ì§€ë„¤ì´ì…˜ */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 24px;
    }
    .page-btn {
      width: 36px;
      height: 36px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      font-size: 0.85rem;
      color: var(--text-light);
      transition: all 0.2s;
    }
    .page-btn:hover { border-color: var(--primary); color: var(--primary); }
    .page-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* ìƒì„¸ ë³´ê¸° */
    .detail-btn {
      background: var(--primary-light);
      color: var(--primary);
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .detail-btn:hover { background: var(--primary); color: #fff; }

    /* ëª¨ë‹¬ */
    .modal-bg {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-bg.show { display: flex; }
    .modal-box {
      background: #fff;
      border-radius: 16px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 24px 48px rgba(0,0,0,0.2);
      animation: modalIn 0.25s ease-out;
    }
    @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h3 { font-size: 1.1rem; font-weight: 700; }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
      line-height: 1;
    }
    .modal-close:hover { color: var(--text); }
    .modal-body { padding: 24px; }
    .detail-section { margin-bottom: 20px; }
    .detail-section h4 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 2px solid var(--primary-light);
    }
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }
    .detail-item label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 2px;
    }
    .detail-item span {
      font-size: 0.9rem;
      color: var(--text);
    }

    @media (max-width: 768px) {
      .header { padding: 20px; }
      .header h1 { font-size: 1.2rem; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .stat-card { padding: 16px; }
      .stat-value { font-size: 1.6rem; }
      .card-header { flex-direction: column; align-items: stretch; }
      .filter-row { flex-direction: column; }
      .search-input { width: 100%; }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="header-row">
      <div>
        <h1>ğŸ“Š ì„¤ë¬¸ ì‘ë‹µ í˜„í™©</h1>
        <p>êµ°ì‚° ê°•ì†ŒíŠ¹êµ¬ G2G í”„ë¡œê·¸ë¨ ìˆ˜í˜œê¸°ì—… ì„±ê³¼ ë° ìˆ˜ìš”ì¡°ì‚¬</p>
      </div>
      <button onclick="loadData()" class="btn-back" style="cursor:pointer; min-width:200px; text-align:center; background:#dc2626; border-color:#dc2626; font-size:1rem;">ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </div>

  <!-- í†µê³„ ì¹´ë“œ -->
  <div class="stats-grid">
    <div class="stat-card total">
      <div class="stat-icon">ğŸ“‹</div>
      <div id="statTotal" class="stat-value">-</div>
      <div class="stat-label">ì „ì²´ ì‘ë‹µ</div>
    </div>
    <div class="stat-card g2g">
      <div class="stat-icon">ğŸŒ</div>
      <div id="statG2G" class="stat-value">-</div>
      <div class="stat-label">G2G ì°¸ì—¬ê¸°ì—…</div>
    </div>
    <div class="stat-card general">
      <div class="stat-icon">ğŸ¢</div>
      <div id="statGeneral" class="stat-value">-</div>
      <div class="stat-label">ì¼ë°˜ ìˆ˜í˜œê¸°ì—…</div>
    </div>
    <div class="stat-card today">
      <div class="stat-icon">ğŸ“…</div>
      <div id="statToday" class="stat-value">-</div>
      <div class="stat-label">ì˜¤ëŠ˜ ì‘ë‹µ</div>
    </div>
    <div class="stat-card noresponse">
      <div class="stat-icon">â³</div>
      <div id="statNoResponse" class="stat-value">-</div>
      <div class="stat-label">ë¯¸ì‘ë‹µ ê¸°ì—…</div>
    </div>
  </div>

  <!-- ì‘ë‹µ ëª©ë¡ -->
  <div class="card">
    <div class="card-header">
      <h2>ì‘ë‹µ ê¸°ì—… ëª©ë¡</h2>
      <div class="filter-row">
        <input type="text" id="searchInput" class="search-input" placeholder="ì—…ì²´ëª…, ì‚¬ì—…ìë²ˆí˜¸ ê²€ìƒ‰...">
        <select id="filterType" class="filter-select">
          <option value="">ì „ì²´</option>
          <option value="YES">G2G ì°¸ì—¬ê¸°ì—…</option>
          <option value="NO">ì¼ë°˜ ìˆ˜í˜œê¸°ì—…</option>
        </select>
        <button onclick="exportCSV()" class="btn-export">ì‘ë‹µ ëª©ë¡ CSV ë‹¤ìš´ë¡œë“œ</button>
      </div>
    </div>
    <div class="card-body">
      <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>
      <div id="tableWrap" class="table-wrap" style="display:none;">
        <table>
          <thead>
            <tr>
              <th>No.</th>
              <th>ì œì¶œì¼ì‹œ</th>
              <th>ì‚¬ì—…ìë²ˆí˜¸</th>
              <th>ì—…ì²´ëª…</th>
              <th>ëŒ€í‘œì</th>
              <th>G2G</th>
              <th>ì‘ì„±ì</th>
              <th>ì—°ë½ì²˜</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div id="empty" class="empty" style="display:none;">
        <div class="empty-icon">ğŸ“­</div>
        <p>ì•„ì§ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
      <div id="pagination" class="pagination"></div>
    </div>
  </div>

  <!-- ë¯¸ì‘ë‹µ ëª©ë¡ -->
  <div class="card" style="margin-top: 24px;">
    <div class="card-header">
      <h2>ë¯¸ì‘ë‹µ ê¸°ì—… ëª©ë¡</h2>
      <div class="filter-row">
        <input type="text" id="noResponseSearch" class="search-input" placeholder="ì—…ì²´ëª…, ì‚¬ì—…ìë²ˆí˜¸ ê²€ìƒ‰...">
        <button onclick="exportNoResponseCSV()" class="btn-export">ë¯¸ì‘ë‹µ ëª©ë¡ CSV ë‹¤ìš´ë¡œë“œ</button>
      </div>
    </div>
    <div class="card-body">
      <div id="noResponseLoading" class="loading" style="display:none;">
        <div class="loading-spinner"></div>
        <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
      </div>
      <div id="noResponseTableWrap" class="table-wrap" style="display:none;">
        <table>
          <thead>
            <tr>
              <th>No.</th>
              <th>ì‚¬ì—…ìë²ˆí˜¸</th>
              <th>ì—…ì²´ëª…</th>
              <th>ëŒ€í‘œì</th>
              <th style="max-width:200px;">ë³¸ì‚¬ì£¼ì†Œ</th>
              <th>ì—°ë½ì²˜</th>
              <th>ì´ë©”ì¼</th>
            </tr>
          </thead>
          <tbody id="noResponseTableBody"></tbody>
        </table>
      </div>
      <div id="noResponseEmpty" class="empty" style="display:none;">
        <div class="empty-icon">ğŸ‰</div>
        <p>ëª¨ë“  ê¸°ì—…ì´ ì‘ë‹µì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!</p>
      </div>
      <div id="noResponsePagination" class="pagination"></div>
    </div>
  </div>
</div>

<!-- ìƒì„¸ ëª¨ë‹¬ -->
<div id="detailModal" class="modal-bg">
  <div class="modal-box">
    <div class="modal-header">
      <h3>ğŸ“„ ì‘ë‹µ ìƒì„¸ ì •ë³´</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div id="detailContent" class="modal-body"></div>
  </div>
</div>

<script>
// ===== Supabase ì´ˆê¸°í™” =====
const SUPABASE_URL = 'https://qzgleuukeyfyhryjflzd.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6Z2xldXVrZXlmeWhyeWpmbHpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxOTc3MDUsImV4cCI6MjA4NDc3MzcwNX0.hn50N_GmTiA8EFM166q0IB8XCjssr_TKtvSMrbikM_Y';
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let allData = [];
let filteredData = [];
let currentPage = 1;
const pageSize = 15;

// ë¯¸ì‘ë‹µ ê´€ë ¨
let allCompanies = [];
let noResponseData = [];
let filteredNoResponse = [];
let noResponsePage = 1;

// ===== ì´ˆê¸°í™” =====
document.addEventListener('DOMContentLoaded', () => {
  loadData();
  setupSearch();
});

// ===== ê²€ìƒ‰/í•„í„° ì„¤ì • =====
function setupSearch() {
  document.getElementById('searchInput').addEventListener('input', debounce(applyFilter, 300));
  document.getElementById('filterType').addEventListener('change', applyFilter);
  document.getElementById('noResponseSearch').addEventListener('input', debounce(applyNoResponseFilter, 300));
}

function debounce(fn, delay) {
  let timer;
  return function(...args) {
    clearTimeout(timer);
    timer = setTimeout(() => fn.apply(this, args), delay);
  };
}

// ===== ë°ì´í„° ë¡œë“œ =====
async function loadData() {
  showLoading(true);
  document.getElementById('noResponseLoading').style.display = 'block';
  document.getElementById('noResponseTableWrap').style.display = 'none';
  document.getElementById('noResponseEmpty').style.display = 'none';
  
  // 1. ì‘ë‹µ ë°ì´í„° ë¡œë“œ
  try {
    const { data: responses, error: respError } = await db
      .from('responses')
      .select('*')
      .order('submitted_at', { ascending: false });
    
    if (respError) throw respError;
    allData = responses || [];
  } catch (err) {
    console.error('ì‘ë‹µ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', err);
    allData = [];
  }
  
  // 2. ì „ì²´ ê¸°ì—… ë°ì´í„° ë¡œë“œ (ë³„ë„ try-catch)
  try {
    const { data: companies, error: compError } = await db
      .from('companies')
      .select('*')
      .order('id', { ascending: true });
    
    if (compError) throw compError;
    allCompanies = companies || [];
  } catch (err) {
    console.warn('ê¸°ì—… ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨ (RLS ì •ì±… í™•ì¸ í•„ìš”):', err);
    allCompanies = [];
  }
  
  // 3. ë¯¸ì‘ë‹µ ê¸°ì—… ê³„ì‚°
  if (allCompanies.length > 0) {
    const respondedBizNos = new Set(allData.map(r => r.biz_no));
    noResponseData = allCompanies.filter(c => !respondedBizNos.has(c.biz_no));
  } else {
    noResponseData = [];
  }
  
  // 4. UI ì—…ë°ì´íŠ¸
  updateStats();
  applyFilter();
  applyNoResponseFilter();
  
  showLoading(false);
  document.getElementById('noResponseLoading').style.display = 'none';
}

// ===== í†µê³„ ì—…ë°ì´íŠ¸ =====
function updateStats() {
  const total = allData.length;
  const g2g = allData.filter(d => d.g2g_flag === 'YES').length;
  const general = allData.filter(d => d.g2g_flag !== 'YES').length;
  
  // ì˜¤ëŠ˜ ë‚ ì§œ ì‘ë‹µ ìˆ˜
  const today = new Date().toISOString().split('T')[0];
  const todayCount = allData.filter(d => {
    if (!d.submitted_at) return false;
    return d.submitted_at.split('T')[0] === today;
  }).length;
  
  // ë¯¸ì‘ë‹µ ìˆ˜
  const noResponseCount = noResponseData.length;
  
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statG2G').textContent = g2g;
  document.getElementById('statGeneral').textContent = general;
  document.getElementById('statToday').textContent = todayCount;
  document.getElementById('statNoResponse').textContent = noResponseCount;
}

// ===== í•„í„° ì ìš© =====
function applyFilter() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
  const filterType = document.getElementById('filterType').value;
  
  filteredData = allData.filter(d => {
    // G2G í•„í„°
    if (filterType && d.g2g_flag !== filterType) return false;
    
    // ê²€ìƒ‰ì–´ í•„í„°
    if (searchTerm) {
      const searchFields = [
        d.biz_no || '',
        d.company_name || '',
        d.ceo || '',
        d.writer_name || ''
      ].join(' ').toLowerCase();
      if (!searchFields.includes(searchTerm)) return false;
    }
    
    return true;
  });
  
  currentPage = 1;
  renderTable();
}

// ===== í…Œì´ë¸” ë Œë”ë§ =====
function renderTable() {
  const tbody = document.getElementById('tableBody');
  const pagination = document.getElementById('pagination');
  
  if (filteredData.length === 0) {
    document.getElementById('tableWrap').style.display = 'none';
    document.getElementById('empty').style.display = 'block';
    pagination.innerHTML = '';
    return;
  }
  
  document.getElementById('tableWrap').style.display = 'block';
  document.getElementById('empty').style.display = 'none';
  
  // í˜ì´ì§€ ê³„ì‚°
  const totalPages = Math.ceil(filteredData.length / pageSize);
  const startIdx = (currentPage - 1) * pageSize;
  const pageData = filteredData.slice(startIdx, startIdx + pageSize);
  
  // í…Œì´ë¸” ë Œë”ë§
  tbody.innerHTML = pageData.map((d, i) => {
    const no = filteredData.length - startIdx - i;
    const dateStr = d.submitted_at ? formatDate(d.submitted_at) : '-';
    const isG2G = d.g2g_flag === 'YES';
    
    return `
      <tr>
        <td class="text-muted">${no}</td>
        <td>${dateStr}</td>
        <td><strong>${d.biz_no || '-'}</strong></td>
        <td>${d.company_name || '-'}</td>
        <td>${d.ceo || '-'}</td>
        <td><span class="badge ${isG2G ? 'badge-g2g' : 'badge-general'}">${isG2G ? 'G2G' : 'ì¼ë°˜'}</span></td>
        <td>${d.writer_name || '-'}</td>
        <td>${d.writer_phone || '-'}</td>
        <td><button class="detail-btn" onclick="showDetail(${d.id})">ìƒì„¸</button></td>
      </tr>
    `;
  }).join('');
  
  // í˜ì´ì§€ë„¤ì´ì…˜
  renderPagination(totalPages);
}

function renderPagination(totalPages) {
  const pagination = document.getElementById('pagination');
  
  if (totalPages <= 1) {
    pagination.innerHTML = '';
    return;
  }
  
  let html = '';
  
  // ì´ì „ ë²„íŠ¼
  html += `<button class="page-btn" onclick="goPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&lt;</button>`;
  
  // í˜ì´ì§€ ë²ˆí˜¸
  const start = Math.max(1, currentPage - 2);
  const end = Math.min(totalPages, currentPage + 2);
  
  if (start > 1) {
    html += `<button class="page-btn" onclick="goPage(1)">1</button>`;
    if (start > 2) html += `<button class="page-btn" disabled>...</button>`;
  }
  
  for (let i = start; i <= end; i++) {
    html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goPage(${i})">${i}</button>`;
  }
  
  if (end < totalPages) {
    if (end < totalPages - 1) html += `<button class="page-btn" disabled>...</button>`;
    html += `<button class="page-btn" onclick="goPage(${totalPages})">${totalPages}</button>`;
  }
  
  // ë‹¤ìŒ ë²„íŠ¼
  html += `<button class="page-btn" onclick="goPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>&gt;</button>`;
  
  pagination.innerHTML = html;
}

function goPage(page) {
  const totalPages = Math.ceil(filteredData.length / pageSize);
  if (page < 1 || page > totalPages) return;
  currentPage = page;
  renderTable();
  window.scrollTo({ top: 300, behavior: 'smooth' });
}

// ===== ìƒì„¸ ë³´ê¸° =====
function showDetail(id) {
  const d = allData.find(item => item.id === id);
  if (!d) return;
  
  const content = document.getElementById('detailContent');
  
  content.innerHTML = `
    <div class="detail-section">
      <h4>ğŸ“Œ ê¸°ì—… ì •ë³´</h4>
      <div class="detail-grid">
        <div class="detail-item"><label>ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</label><span>${d.biz_no || '-'}</span></div>
        <div class="detail-item"><label>ì—…ì²´ëª…</label><span>${d.company_name || '-'}</span></div>
        <div class="detail-item"><label>ëŒ€í‘œì</label><span>${d.ceo || '-'}</span></div>
        <div class="detail-item"><label>ì„¤ë¦½ë…„ë„</label><span>${d.found_year || '-'}</span></div>
        <div class="detail-item"><label>ì—…ì¢…</label><span>${d.industry || '-'}</span></div>
        <div class="detail-item"><label>ë²•ì¸ë“±ë¡ë²ˆí˜¸</label><span>${d.corp_no || '-'}</span></div>
        <div class="detail-item"><label>ë³¸ì‚¬ì£¼ì†Œ</label><span>${d.addr_hq || '-'}</span></div>
        <div class="detail-item"><label>ë³¸ì‚¬ì „í™”</label><span>${d.tel_hq || '-'}</span></div>
      </div>
    </div>
    
    <div class="detail-section">
      <h4>ğŸ‘¤ ì‘ì„±ì ì •ë³´</h4>
      <div class="detail-grid">
        <div class="detail-item"><label>ì‘ì„±ì</label><span>${d.writer_name || '-'}</span></div>
        <div class="detail-item"><label>ë¶€ì„œ</label><span>${d.writer_dept || '-'}</span></div>
        <div class="detail-item"><label>ì—°ë½ì²˜</label><span>${d.writer_phone || '-'}</span></div>
        <div class="detail-item"><label>ì´ë©”ì¼</label><span>${d.writer_email || '-'}</span></div>
      </div>
    </div>
    
    <div class="detail-section">
      <h4>ğŸ“Š ê²½ì˜í˜„í™© (2024ë…„)</h4>
      <div class="detail-grid">
        <div class="detail-item"><label>ë§¤ì¶œì•¡</label><span>${fmtNum(d.sales_2024) || '-'} ë°±ë§Œì›</span></div>
        <div class="detail-item"><label>ìˆ˜ì¶œì•¡</label><span>${fmtNum(d.export_2024) || '-'} ë°±ë§Œì›</span></div>
        <div class="detail-item"><label>ìë³¸ê¸ˆ</label><span>${fmtNum(d.capital_2024) || '-'} ë°±ë§Œì›</span></div>
        <div class="detail-item"><label>ì—°êµ¬ê°œë°œë¹„</label><span>${fmtNum(d.rnd_2024) || '-'} ë°±ë§Œì›</span></div>
        <div class="detail-item"><label>ì¢…ì‚¬ììˆ˜</label><span>${fmtNum(d.emp_2024) || '-'} ëª…</span></div>
        <div class="detail-item"><label>ì£¼ë ¥ì œí’ˆ</label><span>${d.main_product || '-'}</span></div>
      </div>
    </div>
    
    <div class="detail-section">
      <h4>â­ ë§Œì¡±ë„ (ì „ë°˜ì )</h4>
      <div class="detail-grid">
        <div class="detail-item"><label>ì‚¬ì—…ì¶”ì§„ì²´ê³„ ë§Œì¡±ë„ (C1-13)</label><span>${d.c1_13 || '-'} / 5</span></div>
        <div class="detail-item"><label>ì‚¬ì—…ê²°ê³¼ ë§Œì¡±ë„ (C2-1)</label><span>${d.c2_1 || '-'} / 5</span></div>
        <div class="detail-item"><label>ì¬ì¶”ì§„ ì˜í–¥</label><span>${d.c3_retry || '-'} / 5</span></div>
        <div class="detail-item"><label>ì¶”ì²œ ì˜í–¥</label><span>${d.c3_recommend || '-'} / 5</span></div>
      </div>
    </div>
    
    ${d.g2g_flag === 'YES' ? `
    <div class="detail-section">
      <h4>ğŸŒ G2G ë§Œì¡±ë„ ë° ìˆ˜ìš”ì¡°ì‚¬</h4>
      <div class="detail-grid">
        <div class="detail-item"><label>G2G ì‹œë²”ì‚¬ì—… ë§Œì¡±ë„</label><span>${d.d1_sat || '-'} / 5</span></div>
        <div class="detail-item"><label>í–¥í›„ í™•ëŒ€ ê¸°ëŒ€ì •ë„</label><span>${d.e1_expect || '-'} / 5</span></div>
        <div class="detail-item"><label>í•„ìš”ì„± ì¸ì‹</label><span>${d.e2_need || '-'} / 5</span></div>
        <div class="detail-item"><label>ì°¸ì—¬ ì˜ì‚¬</label><span>${d.e3_participate || '-'} / 5</span></div>
      </div>
    </div>
    ` : ''}
    
    <div class="detail-section">
      <h4>ğŸ’¬ ê°œì„  ì œì•ˆ</h4>
      <div class="detail-item" style="width:100%;">
        <span style="white-space:pre-wrap; background:#f8fafc; padding:12px; border-radius:8px; display:block;">${d.c4_suggestion || '(ì—†ìŒ)'}</span>
      </div>
    </div>
    
    <div style="text-align:right; margin-top:16px; color:var(--text-muted); font-size:0.8rem;">
      ì œì¶œì¼ì‹œ: ${d.submitted_at ? formatDate(d.submitted_at) : '-'}
    </div>
  `;
  
  document.getElementById('detailModal').classList.add('show');
}

function closeModal() {
  document.getElementById('detailModal').classList.remove('show');
}

// ===== ë¯¸ì‘ë‹µ í•„í„° ì ìš© =====
function applyNoResponseFilter() {
  // companies í…Œì´ë¸” ë¡œë“œ ì‹¤íŒ¨ ì‹œ
  if (allCompanies.length === 0) {
    document.getElementById('noResponseTableWrap').style.display = 'none';
    document.getElementById('noResponseEmpty').style.display = 'block';
    document.getElementById('noResponseEmpty').innerHTML = `
      <div class="empty-icon">âš ï¸</div>
      <p>ê¸°ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br><small style="color:#94a3b8;">Supabase companies í…Œì´ë¸”ì˜ RLS ì •ì±…ì„ í™•ì¸í•˜ì„¸ìš”.</small></p>
    `;
    document.getElementById('noResponsePagination').innerHTML = '';
    return;
  }
  
  const searchTerm = document.getElementById('noResponseSearch').value.toLowerCase().trim();
  
  filteredNoResponse = noResponseData.filter(c => {
    if (searchTerm) {
      const searchFields = [
        c.biz_no || '',
        c.company_name || '',
        c.ceo || ''
      ].join(' ').toLowerCase();
      if (!searchFields.includes(searchTerm)) return false;
    }
    return true;
  });
  
  noResponsePage = 1;
  renderNoResponseTable();
}

// ===== ë¯¸ì‘ë‹µ í…Œì´ë¸” ë Œë”ë§ =====
function renderNoResponseTable() {
  const tbody = document.getElementById('noResponseTableBody');
  const pagination = document.getElementById('noResponsePagination');
  const emptyEl = document.getElementById('noResponseEmpty');
  
  if (filteredNoResponse.length === 0) {
    document.getElementById('noResponseTableWrap').style.display = 'none';
    emptyEl.style.display = 'block';
    emptyEl.innerHTML = `
      <div class="empty-icon">ğŸ‰</div>
      <p>ëª¨ë“  ê¸°ì—…ì´ ì‘ë‹µì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!</p>
    `;
    pagination.innerHTML = '';
    return;
  }
  
  document.getElementById('noResponseTableWrap').style.display = 'block';
  document.getElementById('noResponseEmpty').style.display = 'none';
  
  // í˜ì´ì§€ ê³„ì‚°
  const totalPages = Math.ceil(filteredNoResponse.length / pageSize);
  const startIdx = (noResponsePage - 1) * pageSize;
  const pageData = filteredNoResponse.slice(startIdx, startIdx + pageSize);
  
  // í…Œì´ë¸” ë Œë”ë§
  tbody.innerHTML = pageData.map((c, i) => {
    const no = filteredNoResponse.length - startIdx - i;
    return `
      <tr>
        <td class="text-muted">${no}</td>
        <td><strong>${c.biz_no || '-'}</strong></td>
        <td>${c.company_name || '-'}</td>
        <td>${c.ceo || '-'}</td>
        <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${c.addr_hq || ''}">${c.addr_hq || '-'}</td>
        <td>${c.tel_hq || '-'}</td>
        <td>${c.email || '-'}</td>
      </tr>
    `;
  }).join('');
  
  // í˜ì´ì§€ë„¤ì´ì…˜
  renderNoResponsePagination(totalPages);
}

function renderNoResponsePagination(totalPages) {
  const pagination = document.getElementById('noResponsePagination');
  
  if (totalPages <= 1) {
    pagination.innerHTML = '';
    return;
  }
  
  let html = '';
  
  html += `<button class="page-btn" onclick="goNoResponsePage(${noResponsePage - 1})" ${noResponsePage === 1 ? 'disabled' : ''}>&lt;</button>`;
  
  const start = Math.max(1, noResponsePage - 2);
  const end = Math.min(totalPages, noResponsePage + 2);
  
  if (start > 1) {
    html += `<button class="page-btn" onclick="goNoResponsePage(1)">1</button>`;
    if (start > 2) html += `<button class="page-btn" disabled>...</button>`;
  }
  
  for (let i = start; i <= end; i++) {
    html += `<button class="page-btn ${i === noResponsePage ? 'active' : ''}" onclick="goNoResponsePage(${i})">${i}</button>`;
  }
  
  if (end < totalPages) {
    if (end < totalPages - 1) html += `<button class="page-btn" disabled>...</button>`;
    html += `<button class="page-btn" onclick="goNoResponsePage(${totalPages})">${totalPages}</button>`;
  }
  
  html += `<button class="page-btn" onclick="goNoResponsePage(${noResponsePage + 1})" ${noResponsePage === totalPages ? 'disabled' : ''}>&gt;</button>`;
  
  pagination.innerHTML = html;
}

function goNoResponsePage(page) {
  const totalPages = Math.ceil(filteredNoResponse.length / pageSize);
  if (page < 1 || page > totalPages) return;
  noResponsePage = page;
  renderNoResponseTable();
}

// ===== ë¯¸ì‘ë‹µ CSV ë‚´ë³´ë‚´ê¸° =====
function exportNoResponseCSV() {
  if (filteredNoResponse.length === 0) {
    alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  const headers = ['No', 'ì‚¬ì—…ìë²ˆí˜¸', 'ì—…ì²´ëª…', 'ëŒ€í‘œì', 'ì„¤ë¦½ë…„ë„', 'ë³¸ì‚¬ì£¼ì†Œ', 'ë³¸ì‚¬ì „í™”', 'ì´ë©”ì¼'];
  
  const rows = filteredNoResponse.map((c, i) => [
    filteredNoResponse.length - i,
    c.biz_no || '',
    c.company_name || '',
    c.ceo || '',
    c.found_year || '',
    c.addr_hq || '',
    c.tel_hq || '',
    c.email || ''
  ]);
  
  const csvContent = '\uFEFF' + [headers, ...rows]
    .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
    .join('\n');
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `êµ°ì‚°ê°•ì†ŒíŠ¹êµ¬_ë¯¸ì‘ë‹µê¸°ì—…_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
}

// ===== CSV ë‚´ë³´ë‚´ê¸° =====
function exportCSV() {
  if (filteredData.length === 0) {
    alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  // CSV í—¤ë”
  const headers = [
    'ì œì¶œì¼ì‹œ', 'ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸', 'ì—…ì²´ëª…', 'ëŒ€í‘œì', 'ì„¤ë¦½ë…„ë„', 'ì—…ì¢…',
    'ë³¸ì‚¬ì£¼ì†Œ', 'ë³¸ì‚¬ì „í™”', 'G2Gì°¸ì—¬', 'ì‘ì„±ì', 'ë¶€ì„œ', 'ì—°ë½ì²˜', 'ì´ë©”ì¼',
    'ë§¤ì¶œì•¡_2022', 'ë§¤ì¶œì•¡_2023', 'ë§¤ì¶œì•¡_2024', 'ë§¤ì¶œì•¡_2025',
    'ìˆ˜ì¶œì•¡_2024', 'ìë³¸ê¸ˆ_2024', 'ì—°êµ¬ê°œë°œë¹„_2024', 'ì¢…ì‚¬ììˆ˜_2024',
    'ì£¼ë ¥ì œí’ˆ', 'ì£¼ë ¥ì œí’ˆë¹„ì¤‘',
    'C1_ì „ë°˜ë§Œì¡±ë„', 'C2_ì‚¬ì—…ê²°ê³¼ë§Œì¡±ë„', 'C3_ì¬ì¶”ì§„ì˜í–¥', 'C3_ì¶”ì²œì˜í–¥',
    'D1_G2Gë§Œì¡±ë„', 'E1_ê¸°ëŒ€ì •ë„', 'E2_í•„ìš”ì„±', 'E3_ì°¸ì—¬ì˜ì‚¬',
    'ê°œì„ ì œì•ˆ'
  ];
  
  // CSV ë°ì´í„°
  const rows = filteredData.map(d => [
    d.submitted_at ? formatDate(d.submitted_at) : '',
    d.biz_no || '',
    d.company_name || '',
    d.ceo || '',
    d.found_year || '',
    d.industry || '',
    d.addr_hq || '',
    d.tel_hq || '',
    d.g2g_flag === 'YES' ? 'G2G' : 'ì¼ë°˜',
    d.writer_name || '',
    d.writer_dept || '',
    d.writer_phone || '',
    d.writer_email || '',
    d.sales_2022 || '',
    d.sales_2023 || '',
    d.sales_2024 || '',
    d.sales_2025 || '',
    d.export_2024 || '',
    d.capital_2024 || '',
    d.rnd_2024 || '',
    d.emp_2024 || '',
    d.main_product || '',
    d.main_product_ratio || '',
    d.c1_13 || '',
    d.c2_1 || '',
    d.c3_retry || '',
    d.c3_recommend || '',
    d.d1_sat || '',
    d.e1_expect || '',
    d.e2_need || '',
    d.e3_participate || '',
    (d.c4_suggestion || '').replace(/\n/g, ' ')
  ]);
  
  // CSV ë¬¸ìì—´ ìƒì„±
  const csvContent = '\uFEFF' + [headers, ...rows]
    .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
    .join('\n');
  
  // ë‹¤ìš´ë¡œë“œ
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `êµ°ì‚°ê°•ì†ŒíŠ¹êµ¬_ì„¤ë¬¸ì‘ë‹µ_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
}

// ===== ìœ í‹¸ =====
function formatDate(dateStr) {
  const d = new Date(dateStr);
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  const h = String(d.getHours()).padStart(2, '0');
  const min = String(d.getMinutes()).padStart(2, '0');
  return `${y}-${m}-${day} ${h}:${min}`;
}

function fmtNum(n) {
  if (!n) return '';
  return String(n).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function showLoading(show) {
  document.getElementById('loading').style.display = show ? 'block' : 'none';
  if (show) {
    document.getElementById('tableWrap').style.display = 'none';
    document.getElementById('empty').style.display = 'none';
  }
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.getElementById('detailModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

// ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeModal();
});

// ===== PWA Service Worker ë“±ë¡ =====
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('SW ë“±ë¡ ì™„ë£Œ:', reg.scope))
      .catch(err => console.log('SW ë“±ë¡ ì‹¤íŒ¨:', err));
  });
}

// ===== PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ =====
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  showInstallBanner();
});

function showInstallBanner() {
  // ì´ë¯¸ ì„¤ì¹˜ëœ ê²½ìš° ë˜ëŠ” ì´ë¯¸ ë°°ë„ˆë¥¼ ë‹«ì€ ê²½ìš° í‘œì‹œ ì•ˆí•¨
  if (window.matchMedia('(display-mode: standalone)').matches) return;
  if (sessionStorage.getItem('pwa_banner_closed')) return;
  
  const banner = document.createElement('div');
  banner.id = 'pwa-banner';
  banner.innerHTML = `
    <div style="position:fixed;bottom:20px;left:16px;right:16px;background:linear-gradient(135deg,#1e1b4b,#312e81);color:#fff;padding:20px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.3);z-index:9998;animation:slideUp 0.4s ease-out;">
      <button onclick="closeInstallBanner()" style="position:absolute;top:12px;right:12px;background:transparent;border:none;color:#fff;font-size:1.3rem;cursor:pointer;opacity:0.6;line-height:1;padding:4px;">&times;</button>
      <div style="font-weight:700;font-size:1.1rem;margin-bottom:8px;">ğŸ“± ì•±ìœ¼ë¡œ ì„¤ì¹˜</div>
      <div style="font-size:0.85rem;opacity:0.85;margin-bottom:16px;">í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ë©´ ë” ë¹ ë¥´ê²Œ ì ‘ì†í•  ìˆ˜ ìˆì–´ìš”!</div>
      <button onclick="installPWA()" style="width:100%;background:#fff;color:#312e81;border:none;padding:14px;border-radius:12px;font-weight:700;font-size:1rem;cursor:pointer;">ì„¤ì¹˜í•˜ê¸°</button>
    </div>
  `;
  document.body.appendChild(banner);
  
  // ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ ì¶”ê°€
  if (!document.getElementById('pwa-style')) {
    const style = document.createElement('style');
    style.id = 'pwa-style';
    style.textContent = '@keyframes slideUp{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}';
    document.head.appendChild(style);
  }
}

function installPWA() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(choice => {
      if (choice.outcome === 'accepted') {
        console.log('PWA ì„¤ì¹˜ ì™„ë£Œ');
      }
      deferredPrompt = null;
      closeInstallBanner();
    });
  }
}

function closeInstallBanner() {
  const banner = document.getElementById('pwa-banner');
  if (banner) banner.remove();
  sessionStorage.setItem('pwa_banner_closed', 'true');
}
</script>
</body>
</html>

